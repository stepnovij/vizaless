  <!DOCTYPE html>
  <html>
    <head>
      <!--Import Google Icon Font-->
      <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
      <!--Import materialize.css-->
      <link type="text/css" rel="stylesheet" href="static/materialize/css/materialize.min.css"  media="screen,projection"/>

      <!--Let browser know website is optimized for mobile-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    </head>
    <script>
        function _doSubmit(){

            elm = document.getElementById("error-block");
            elm.style.display = "none";

            return new Promise(function(resolve, reject) {
                let formData = new FormData();
                let request = new XMLHttpRequest();
                request.open('POST', "/upload");
                // request.setRequestHeader('content-type', 'multipart/form-data');
                inputFile = document.getElementById('file_input_file');
                formData.append('the_file', inputFile.files[0]);

                request.onload = function () {
                    if (request.status === 200) {
                        resolve(request.response);

                    } else {
                        if (request.status === 400) {
                            let error = JSON.parse(request.response);
                            elm = document.getElementById("error-block");
                            elm.style.display = "block";
                            msg = error.message;
                            elm.innerHTML = msg;
                        }
                    }
                    progressElm = document.getElementById("progress");
                    progressElm.style.display = "none";
                };
                request.onerror = function () {
                    // Also deal with the case when the entire request fails to begin with
                    // This is probably a network error, so reject the promise with an appropriate message
                    reject(Error('There was a network error.'));
                };
                request.send(formData);

            });
        }
        function doSubmit() {
            document.getElementById("progress").style.display = "block";
            document.getElementById("fileSender").style.display = "none";
            _doSubmit().then(
                function(response) {
                    let field = document.getElementById("fileUploader");
                    field.style.display = "none";
                    document.getElementById("amoCRMuploader").style.display = "block";
                    let data_from_server = JSON.parse(response);

                    let name = "";
                    if (data_from_server.FirstNameFatherNameRus){
                      let res = data_from_server.FirstNameFatherNameRus.split(' ');
                      name = data_from_server.LastNameRus + ' ' + res[0].slice(0, 1) + '.' + res[1].slice(0, 1)+ '.';
                    }

                    document.getElementById("path").value = data_from_server.path;
                    document.getElementById("FIO").value = data_from_server.LastNameRus + ' ' + data_from_server.FirstNameFatherNameRus;
                    document.getElementById("FIO_2").value = name;
                    document.getElementById("first_name").value = data_from_server.GivenName;
                    document.getElementById("last_name").value = data_from_server.LastName;
                    document.getElementById("birthdate").value = data_from_server.BirthDate;
                    document.getElementById("nationality").value = data_from_server.Nationality;
                    document.getElementById("birthcity").value = data_from_server.PlaceOfBirthCityTranslit + '/' + data_from_server.PlaceOfBirthCountry;
                    document.getElementById("document_number").value = data_from_server.DocumentNumber;
                    document.getElementById("issuedate").value = data_from_server.IssueDate;
                    document.getElementById("expirydate").value = data_from_server.ExpiryDate;
                    document.getElementById("issueorganization").value = data_from_server.IssuerOrganizationTranslit;
                    document.getElementById("fileUploader").reset();
                }, function(Error) {
                    console.log(Error);
            });
            return false;
        }
        function doSubmitAmoCRM(){
            let formData = new FormData();
            let request = new XMLHttpRequest();
            let ele = document.getElementsByName('group1');
            let is_recognized;
            for(i = 0; i < ele.length; i++) {
                if(ele[i].checked) is_recognized = ele[i].value;
            }

          let leadId = document.getElementById("lead_id").value;
          if (leadId == '') {
            alert("Номер сделки должен быть заполнен");
            return false;
          }

            let data = JSON.stringify({
                "path": document.getElementById("path").value,
                "lead_id": document.getElementById("lead_id").value,
                "FIO": document.getElementById("FIO").value,
                "FIO_2": document.getElementById("FIO_2").value,
                "GivenName": document.getElementById("first_name").value,
                "LastName": document.getElementById("last_name").value,
                "BirthDate": document.getElementById("birthdate").value,
                "DocumentNumber": document.getElementById("document_number").value,
                "Nationality": document.getElementById("nationality").value,
                "PlaceOfBirthTranslit": document.getElementById("birthcity").value,
                "IssueDate": document.getElementById("issuedate").value,
                "ExpiryDate": document.getElementById("expirydate").value,
                "IssuerOrganizationTranslit": document.getElementById("issueorganization").value,
                "IsRecognized": is_recognized,
            });
            request.open('POST', "/upload_crm");
            request.setRequestHeader('content-type', 'Content-Type: application/json');
            request.send(data);

            document.getElementById("amoCRMuploader").reset();
            document.getElementById("amoCRMuploader").style.display = "none";

            document.getElementById("fileUploader").style.display = "block";
            document.getElementById("fileSender").style.display = "block";

        }
    </script>
    <body>

        <div class="divider"></div>
        <div class="container">
          <div class="row">
            <div class="input-field col s6">


              <form id="fileUploader">
                <div class="file-field input-field">
                  <div class="btn">
                    <span>Файл</span>
                    <input type="file">
                  </div>
                  <div class="file-path-wrapper">
                    <input class="file-path validate" type="text" id="fileInput">
                    <input id="file_input_file" type="file"/>
                  </div>
                </div>
                <button class="btn waves-effect waves-light" id="fileSender" onclick="doSubmit();">Отправить на распознование
                    <i class="material-icons right">send</i>
                </button>
              </form>

              <br>
              <br>
              <div class="row" id="progress" style="display: none;">
                <div class="progress">
                    <div class="indeterminate"></div>
                </div>
              </div>

            </div>
          </div>
            <div class="row">
              <div class="s12">
                <div id="error-block"
                     class="card-panel error"
                     style="background: #ef9a9a; text-align: center; display: none">
                </div>
              </div>
            </div>


            <form class="col s12" id="amoCRMuploader" style="display: none;">
              <div class="input-field col s12" style="display: none;">
                <input id="path" type="text">
              </div>

              <div class="input-field col s12">
                <input id="lead_id" type="text" class="validate" required="">
                <span class="helper-text" data-error="wrong" data-success="right">Контракт номер</span>
                <!--<label class="active" for="first_name">Имя</label>-->
              </div>

              <div class="input-field col s12">
                <input id="FIO" type="text" class="validate">
                <span class="helper-text" data-error="wrong" data-success="right">ФИО</span>
                <!--<label class="active" for="first_name">Имя</label>-->
              </div>

              <div class="input-field col s12">
                <input id="FIO_2" type="text" class="validate">
                <span class="helper-text" data-error="wrong" data-success="right">Фамилия И.О</span>
                <!--<label class="active" for="first_name">Имя</label>-->
              </div>

              <div class="input-field col s12">
                <input id="first_name" type="text" class="validate">
                <span class="helper-text" data-error="wrong" data-success="right">Имя</span>
                <!--<label class="active" for="first_name">Имя</label>-->
              </div>
              <div class="input-field col s12">
                <input id="last_name" type="text" class="validate">
                <span class="helper-text" data-error="wrong" data-success="right">Фамилия</span>
              </div>
              <div class="input-field col s12">
                <input id="birthdate" type="text" class="validate">
                <span class="helper-text" data-error="wrong" data-success="right">День Рождения</span>
              </div>

              <div class="input-field col s12">
                <input id="nationality" type="text" class="validate">
                <span class="helper-text" data-error="wrong" data-success="right">Гражданство</span>
              </div>

              <div class="input-field col s12">
                <input id="birthcity" type="text" class="validate">
                <span class="helper-text" data-error="wrong" data-success="right">Место рождения</span>
              </div>

              <div class="input-field col s12">
                <input id="document_number" type="text" class="validate">
                <span class="helper-text" data-error="wrong" data-success="right">Номер документа</span>
              </div>

              <div class="input-field col s12">
                <input id="issuedate" type="text" class="validate">
                <span class="helper-text" data-error="wrong" data-success="right">Дата выдачи</span>
              </div>
              <div class="input-field col s12">
                <input id="expirydate" type="text" class="validate">
                <span class="helper-text" data-error="wrong" data-success="right">Дата окончания</span>
              </div>

              <div class="input-field col s12">
                <input id="issueorganization" type="text" class="validate">
                <span class="helper-text" data-error="wrong" data-success="right">Орган выдавший документ</span>
              </div>
              <div id="is_recognized" class="input-field col s12">
                <p>
                  <label>
                    <input name="group1" type="radio" value="recognized" checked />
                    <span>Документ распознался</span>
                  </label>
                </p>
                <p>
                  <label>
                    <input name="group1" type="radio" value="not_recognized" />
                    <span>Документ не распознался</span>
                  </label>
                </p>
              </div>
              <button class="btn waves-effect waves-light" onclick="doSubmitAmoCRM();">Отправить в AMOcrm
                  <i class="material-icons right">send</i>
              </button>
            </form>

          </div>
      <!--JavaScript at end of body for optimized loading-->
      <script type="text/javascript" src="static/materialize/js/materialize.min.js"></script>
      <script>
          document.getElementById("fileUploader").addEventListener("submit", function (event) {
              event.preventDefault();
          });

          document.getElementById("amoCRMuploader").addEventListener("submit", function (event) {
              event.preventDefault();
          });

      </script>
    </body>
  </html>

